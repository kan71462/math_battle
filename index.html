<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PokeMath Battle - Timer Edition</title>
    <style>
        :root {
            --primary: #FF5555; /* Red */
            --secondary: #333333; /* Dark Grey */
            --bg-color: #f0f8ff;
            --panel-bg: #ffffff;
            --hp-green: #4caf50;
            --hp-yellow: #ffeb3b;
            --hp-red: #f44336;
            --font-main: 'Verdana', sans-serif;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-color);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px 0;
        }

        .container {
            width: 90%;
            max-width: 700px; /* Increased max-width for better log display */
            background: var(--panel-bg);
            border: 4px solid var(--secondary);
            border-radius: 15px;
            box-shadow: 5px 5px 0px rgba(0,0,0,0.2);
            overflow: hidden;
            position: relative;
        }

        /* Header */
        .header {
            background-color: var(--primary);
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            font-size: 1.5rem;
            border-bottom: 4px solid var(--secondary);
        }

        /* Sections */
        .screen {
            padding: 20px;
            display: none; /* Hidden by default */
        }

        .screen.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Settings Form */
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
        }
        input[type="number"], select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }
        .checkbox-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 5px;
            background: #eee;
            padding: 5px 10px;
            border-radius: 5px;
        }

        /* Battle Arena */
        .arena {
            height: 200px;
            background: linear-gradient(to bottom, #87CEEB 50%, #90EE90 50%);
            position: relative;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid #333;
        }

        .sprite {
            font-size: 4rem;
            position: absolute;
            filter: drop-shadow(2px 4px 0 rgba(0,0,0,0.2));
        }

        .enemy-sprite { 
            top: 20px; 
            right: 40px; 
            animation: float-enemy 2s infinite alternate;
        }
        .player-sprite { 
            bottom: 10px; 
            left: 40px; 
            transform: scaleX(-1); 
            animation: float-player 2s infinite alternate;
        }
        @keyframes float-enemy { from { transform: translateY(0px); } to { transform: translateY(-5px); } }
        @keyframes float-player { from { transform: translateY(0px) scaleX(-1); } to { transform: translateY(-5px) scaleX(-1); } }

        /* HP Bars */
        .hud {
            position: absolute;
            background: white;
            border: 2px solid #333;
            padding: 5px 10px;
            border-radius: 5px;
            width: 140px;
            font-size: 0.8rem;
        }
        .enemy-hud { top: 10px; left: 10px; }
        .player-hud { bottom: 30px; right: 10px; }

        .hp-bar-container {
            width: 100%;
            height: 10px;
            background: #ddd;
            border-radius: 5px;
            margin-top: 5px;
            overflow: hidden;
        }
        .hp-bar {
            height: 100%;
            background: var(--hp-green);
            width: 100%;
            transition: width 0.5s ease, background 0.5s;
        }

        /* Gameplay Area */
        .question-box {
            text-align: center;
            font-size: 2rem;
            font-weight: bold;
            margin: 20px 0 10px 0;
            font-family: 'Courier New', monospace;
        }

        .timer-info {
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 15px;
        }

        .input-area {
            display: flex;
            gap: 10px;
        }
        
        button.btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 20px;
            font-size: 1rem;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
            box-shadow: 0 4px #b33a3a;
            flex: 1;
        }
        button.btn:active {
            transform: translateY(4px);
            box-shadow: 0 0 #b33a3a;
        }
        button.secondary {
            background: #555;
            box-shadow: 0 4px #333;
        }

        /* Logs */
        .log-box {
            background: #f9f9f9;
            border: 2px solid #ccc;
            padding: 10px;
            border-radius: 5px;
            margin-top: 15px;
            font-size: 0.9rem;
        }
        .log-header { font-weight: bold; color: #555; display: flex; justify-content: space-between;}
        .log-details { color: #777; margin-top: 5px; font-style: italic; }
        .correct-text { color: var(--hp-green); font-weight: bold; }
        .wrong-text { color: var(--hp-red); font-weight: bold; }

        /* Results Badge */
        .badge-container {
            text-align: center;
            margin: 30px 0;
        }
        .badge-icon {
            font-size: 5rem;
            margin-bottom: 10px;
            display: block;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            text-align: center;
            margin-bottom: 20px;
        }
        .stat-box {
            background: #eee;
            padding: 10px;
            border-radius: 5px;
        }

        /* Full Log Table */
        .full-log-container {
            margin-top: 20px;
            overflow-x: auto;
            max-height: 400px;
        }
        .full-log-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
        }
        .full-log-table th, .full-log-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        .full-log-table th {
            background-color: #f2f2f2;
            position: sticky;
            top: 0;
        }
        .full-log-table td.correct { background-color: #e6ffe6; }
        .full-log-table td.wrong { background-color: #ffe6e6; }


        /* Utils */
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">POK√â-MATH BATTLE</div>

    <div id="screen-settings" class="screen active">
        <h3>Configure Battle</h3>
        
        <div class="form-group">
            <label>Number of Questions:</label>
            <input type="number" id="setting-count" value="10" min="1" max="50">
        </div>

        <div class="form-group">
            <label>Number of Digits (Difficulty):</label>
            <select id="setting-digits">
                <option value="1">1 Digit (e.g., 5 + 3)</option>
                <option value="2">2 Digits (e.g., 12 + 45)</option>
                <option value="3">3 Digits (e.g., 120 + 305)</option>
                <option value="4">4 Digits (e.g., 1200 + 4500)</option>
                <option value="5">5 Digits (e.g., 12000 + 30500)</option>
            </select>
        </div>

        <div class="form-group">
            <label>Battle Moves (Operations):</label>
            <div class="checkbox-group">
                <div class="checkbox-item"><input type="checkbox" value="+" checked> Addition (+)</div>
                <div class="checkbox-item"><input type="checkbox" value="-" checked> Subtraction (-)</div>
                <div class="checkbox-item"><input type="checkbox" value="*"> Multiplication (√ó)</div>
                <div class="checkbox-item"><input type="checkbox" value="/"> Division (√∑)</div>
            </div>
        </div>

        <button class="btn" onclick="startGame()">START BATTLE</button>
    </div>

    <div id="screen-battle" class="screen">
        
        <div class="arena">
            <div class="hud enemy-hud">
                <strong>Wild Math!</strong>
                <div class="hp-bar-container"><div id="enemy-hp" class="hp-bar"></div></div>
            </div>
            <div class="sprite enemy-sprite">üëæ</div> <div class="sprite player-sprite">ü¶ñ</div> <div class="hud player-hud">
                <strong>You</strong>
                <div class="hp-bar-container"><div id="player-hp" class="hp-bar"></div></div>
            </div>
        </div>

        <div style="display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 10px;">
            <span>Correct: <span id="score-correct" style="color:green">0</span></span>
            <span>Question: <span id="q-current">1</span> / <span id="q-total">10</span></span>
            <span>Wrong: <span id="score-wrong" style="color:red">0</span></span>
        </div>
        
        <div id="timer-display" class="timer-info">Time: 0.00s</div>

        <div id="question-display" class="question-box">Loading...</div>

        <div class="input-area">
            <input type="number" id="answer-input" placeholder="Enter Answer" onkeydown="if(event.key === 'Enter') checkAnswer()">
            <button class="btn" onclick="checkAnswer()">ATTACK!</button>
        </div>

        <div class="log-box">
            <div class="log-header">
                <span>Last Move Status:</span>
                <span id="log-result">---</span>
            </div>
            <div class="log-details" id="log-history">
                Last Q: --- | Your Ans: --- | Correct: ---
            </div>
        </div>
    </div>

    <div id="screen-result" class="screen">
        <div class="badge-container">
            <div id="badge-icon" class="badge-icon">üèÜ</div>
            <h2 id="badge-title">Title</h2>
            <p id="badge-desc">Description</p>
        </div>

        <div class="stats-grid">
            <div class="stat-box">
                <div style="font-size: 0.8rem;">Accuracy</div>
                <strong id="final-accuracy" style="font-size: 1.2rem;">0%</strong>
            </div>
            <div class="stat-box">
                <div style="font-size: 0.8rem;">Score</div>
                <strong id="final-score" style="font-size: 1.2rem;">0/0</strong>
            </div>
        </div>

        <h3>Full Battle Log</h3>
        <div id="full-log-output" class="full-log-container">
            </div>

        <button class="btn" onclick="restartGame()">Battle Again</button>
        <br><br>
        <button class="btn secondary" onclick="goToSettings()">Back to Settings</button>
    </div>
</div>

<script>
    /* --- Game State --- */
    let state = {
        totalQ: 10,
        currentQ: 0,
        digits: 1,
        ops: [],
        correct: 0,
        wrong: 0,
        currentAnswer: 0,
        currentProblemStr: "",
        playerHP: 100,
        enemyHP: 100,
        startTime: 0,          // Time when the current question was generated
        timerInterval: null,   // Reference to the display timer
        battleLog: []          // Array to store all question records
    };

    /* --- Navigation --- */
    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function goToSettings() {
        showScreen('screen-settings');
    }

    /* --- Core Logic --- */
    function startGame() {
        // Stop any running timer from a previous game
        if (state.timerInterval) clearInterval(state.timerInterval);

        // 1. Get Settings
        const count = parseInt(document.getElementById('setting-count').value) || 10;
        const digits = parseInt(document.getElementById('setting-digits').value) || 1;
        const checkedOps = Array.from(document.querySelectorAll('.checkbox-group input:checked')).map(cb => cb.value);
        
        if (checkedOps.length === 0) {
            alert("Please select at least one operation move!");
            return;
        }

        // 2. Initialize State
        state = {
            totalQ: count,
            currentQ: 1,
            digits: digits,
            ops: checkedOps,
            correct: 0,
            wrong: 0,
            currentAnswer: null,
            currentProblemStr: "",
            playerHP: 100,
            enemyHP: 100,
            startTime: 0,
            timerInterval: null,
            battleLog: []
        };

        // 3. Reset UI
        document.getElementById('q-total').innerText = state.totalQ;
        document.getElementById('score-correct').innerText = "0";
        document.getElementById('score-wrong').innerText = "0";
        document.getElementById('log-result').innerText = "Battle Started!";
        document.getElementById('log-result').className = "";
        document.getElementById('log-history').innerText = "Waiting for first move...";
        document.getElementById('answer-input').value = "";
        document.getElementById('answer-input').focus();
        document.getElementById('timer-display').innerText = "Time: 0.00s";
        updateHP();

        // 4. Generate First Question
        generateQuestion();
        showScreen('screen-battle');
    }

    function getRandomNumber(digits) {
        const min = Math.pow(10, digits - 1);
        const max = Math.pow(10, digits) - 1;
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function generateQuestion() {
        document.getElementById('q-current').innerText = state.currentQ;
        
        // Stop previous timer (if any) and start a new one
        if (state.timerInterval) clearInterval(state.timerInterval);
        state.startTime = Date.now();
        state.timerInterval = setInterval(updateTimerDisplay, 10); // Update every 10ms for smooth display

        const op = state.ops[Math.floor(Math.random() * state.ops.length)];
        let num1 = getRandomNumber(state.digits);
        let num2 = getRandomNumber(state.digits);
        let ans = 0;

        // Math Logic Adjustments
        if (op === '/') {
            // Ensure clean division: Result * num2 = num1
            const result = num1; 
            const divisor = num2;
            const dividend = result * divisor;
            
            state.currentProblemStr = `${dividend} √∑ ${divisor}`;
            ans = result;
        } else if (op === '-') {
            // Prevent negative results for simplicity
            if (num1 < num2) [num1, num2] = [num2, num1];
            state.currentProblemStr = `${num1} - ${num2}`;
            ans = num1 - num2;
        } else if (op === '*') {
            state.currentProblemStr = `${num1} √ó ${num2}`;
            ans = num1 * num2;
        } else {
            state.currentProblemStr = `${num1} + ${num2}`;
            ans = num1 + num2;
        }

        state.currentAnswer = ans;
        document.getElementById('question-display').innerText = state.currentProblemStr + " = ?";
    }

    function updateTimerDisplay() {
        const elapsed = (Date.now() - state.startTime) / 1000;
        document.getElementById('timer-display').innerText = `Time: ${elapsed.toFixed(2)}s`;
    }

    function updateHP() {
        const pBar = document.getElementById('player-hp');
        const eBar = document.getElementById('enemy-hp');

        pBar.style.width = state.playerHP + "%";
        eBar.style.width = state.enemyHP + "%";

        // Color logic
        const setCol = (bar, hp) => {
            if (hp > 50) bar.style.background = "var(--hp-green)";
            else if (hp > 20) bar.style.background = "var(--hp-yellow)";
            else bar.style.background = "var(--hp-red)";
        };

        setCol(pBar, state.playerHP);
        setCol(eBar, state.enemyHP);
    }

    function checkAnswer() {
        const inputEl = document.getElementById('answer-input');
        const userAns = parseFloat(inputEl.value);

        if (isNaN(userAns)) return; // Ignore empty input
        
        // --- Timer Stop & Calculation ---
        if (state.timerInterval) clearInterval(state.timerInterval);
        const timeTaken = (Date.now() - state.startTime) / 1000;
        document.getElementById('timer-display').innerText = `Time: ${timeTaken.toFixed(2)}s`;

        const isCorrect = (userAns === state.currentAnswer);
        const damageStep = 100 / state.totalQ;

        // --- Update Battle Log Array ---
        state.battleLog.push({
            question: state.currentProblemStr,
            userAnswer: userAns,
            correctAnswer: state.currentAnswer,
            timeTaken: timeTaken.toFixed(2),
            isCorrect: isCorrect,
            qNum: state.currentQ
        });

        // --- Update Scores & HP ---
        const logRes = document.getElementById('log-result');
        const logHist = document.getElementById('log-history');

        if (isCorrect) {
            state.correct++;
            state.enemyHP = Math.max(0, state.enemyHP - damageStep);
            logRes.innerText = "It's super effective! (Correct)";
            logRes.className = "correct-text";
        } else {
            state.wrong++;
            state.playerHP = Math.max(0, state.playerHP - damageStep);
            logRes.innerText = "Attack missed! You took damage. (Wrong)";
            logRes.className = "wrong-text";
        }

        // History Text (Last move summary)
        logHist.innerText = `Last Q: ${state.currentProblemStr} | Your Ans: ${userAns} | Correct: ${state.currentAnswer} | Time: ${timeTaken.toFixed(2)}s`;

        document.getElementById('score-correct').innerText = state.correct;
        document.getElementById('score-wrong').innerText = state.wrong;
        updateHP();

        // Clean Input
        inputEl.value = "";
        inputEl.focus();

        // Check Game Over or Next Question
        if (state.currentQ >= state.totalQ) {
            endGame();
        } else {
            state.currentQ++;
            generateQuestion();
        }
    }

    function endGame() {
        if (state.timerInterval) clearInterval(state.timerInterval);
        showScreen('screen-result');
        
        const accuracy = state.totalQ > 0 ? Math.round((state.correct / state.totalQ) * 100) : 0;
        
        document.getElementById('final-score').innerText = `${state.correct} / ${state.totalQ}`;
        document.getElementById('final-accuracy').innerText = `${accuracy}%`;

        // Badge Logic
        const badgeIcon = document.getElementById('badge-icon');
        const badgeTitle = document.getElementById('badge-title');
        const badgeDesc = document.getElementById('badge-desc');

        if (accuracy === 100) {
            badgeIcon.innerText = "üëë";
            badgeTitle.innerText = "MATH MASTER";
            badgeDesc.innerText = "Perfect Score! You are a legendary trainer!";
            badgeTitle.style.color = "#FFD700"; // Gold
        } else if (accuracy >= 80) {
            badgeIcon.innerText = "ü•á";
            badgeTitle.innerText = "GYM LEADER";
            badgeDesc.innerText = "Excellent work! You crushed the gym!";
            badgeTitle.style.color = "#C0C0C0"; // Silver
        } else if (accuracy >= 50) {
            badgeIcon.innerText = "ü•à";
            badgeTitle.innerText = "TRAINER";
            badgeDesc.innerText = "Good fight! Keep training to get stronger.";
            badgeTitle.style.color = "#CD7F32"; // Bronze
        } else {
            badgeIcon.innerText = "ü©π";
            badgeTitle.innerText = "ROOKIE";
            badgeDesc.innerText = "You fainted! Head to the PokeCenter and try again.";
            badgeTitle.style.color = "#333";
        }

        // Generate Full Log Table
        generateFullLogTable();
    }
    
    function generateFullLogTable() {
        const logContainer = document.getElementById('full-log-output');
        let html = `
            <table class="full-log-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Question</th>
                        <th>Your Answer</th>
                        <th>Correct Answer</th>
                        <th>Time Taken (s)</th>
                        <th>Result</th>
                    </tr>
                </thead>
                <tbody>
        `;

        state.battleLog.forEach(log => {
            const resultClass = log.isCorrect ? 'correct' : 'wrong';
            const resultText = log.isCorrect ? 'CORRECT' : 'WRONG';
            html += `
                <tr>
                    <td>${log.qNum}</td>
                    <td>${log.question}</td>
                    <td class="${resultClass}">${log.userAnswer}</td>
                    <td>${log.correctAnswer}</td>
                    <td>${log.timeTaken}</td>
                    <td class="${resultClass}">${resultText}</td>
                </tr>
            `;
        });

        html += `
                </tbody>
            </table>
        `;
        logContainer.innerHTML = html;
    }

    function restartGame() {
        startGame(); // Re-uses settings from last time
    }
</script>

</body>
</html>